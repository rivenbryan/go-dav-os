name: Build

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ opened, synchronize ]

jobs:
  build-run:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write 

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Try pulling toolchain image
        id: pullimg
        continue-on-error: true
        run: docker pull ghcr.io/dmarro89/go-dav-os-toolchain:latest

      - name: Build toolchain image if missing/changed (cached)
        if: steps.pullimg.outcome != 'success'
        run: |
          docker buildx build --platform=linux/amd64 \
            --cache-from type=gha --cache-to type=gha,mode=max \
            -t ghcr.io/dmarro89/go-dav-os-toolchain:latest \
            --load \
            .
      
      - name: Push image
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        run: docker push ghcr.io/dmarro89/go-dav-os-toolchain:latest

      - name: Build ISO
        run: |
          docker run --rm --platform=linux/amd64 \
            -v "$PWD":/work -w /work \
            ghcr.io/dmarro89/go-dav-os-toolchain:latest \
            make -j$(nproc)

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: dav-go-os-iso
          path: build/dav-go-os.iso